---
author:
- Richard Hernandez
date: 2021 April 28
title: CIS 3213 - Final Project and Report
---

# Abstract

The purpose of this paper is to describe the phases of an attack when
using the "CVE-2021-30657" exploit.[@apple-cve] This allows an adversary
to bypass Mac's "Gatekeeper" checks.[@exploit-about] Gatekeeper is a
technology used to ensure that only software deemed "safe" is allowed to
run on OSX.[@gatekeeper-about] Bypassing this safety check allows any
unwanted program to run inside the operating system. This is
accomplished through a script-based solution. In this attack, a script
is used to successfully and quietly launch a ransomware binary on a
victim's computer.

A "DHS Kill-Chain," represented in the following graphic, is used to
organize the stages of the attack.

![image](C:/Users/Eric-PC/Documents/usf/spring2021/cis3213/final-project/dhs-kill-chain.png)

# Scenario introduction

This section will define the key actors for the scenario, and organize
each into their own roles by defining the STIX attributes.

## Threat actor

Security researcher Cedric Owns first discovered the vulnerability, and
researcher Patrick Warble wrote an extensive technical discussion on how
the exploit is possible.[@gatekeeper-about] For the purpose of this
paper, we will use the threat actor of Thom, a hoodie-wearing black-hat
hacker. His friend, Alex, who swears by Apple products, will not stop
pestering Thom about the company's products. This time, Alex has gone
too far. Also, Thom hates Alex. Thom has been pushed beyond the limits
of his patience, and wants to expose the weaknesses in his friend's
security posture.

## Target

The target will be Alex's main Macbook, which Alex will bring to Thom's
house when Thom invites him over to "hang out." Through guiding
questions from recent conversations, Thom was able to learn that Alex
uses a Macbook that has not been updated in over a year. This means,
Apple's 11.3 update, which fixes this vulnerability, has not yet been
applied. Specifically, he learns that Alex is running OSX version
11.2.3. So, Thom chooses an exploit that will run on this outdated
version.

## Campaign

For this scenario, Thom will invite Alex over to his house to "hang out
and day-drink." He will wait until Alex is sufficiently drunk, and then
start talking about computers. He know that Alex, who is already eager
to talk about Apple products, will be even more cavalier once
inebriated. He will wait until Alex is away from his computer, and then,
run the exploit.

## The Exploit

Thom reaches out to a professional contact, Patrick. Patrick sends him a
"script-based malware" that's already contained in a normal application
bundle. The way to bypass Gatekeeper checks is simple: placing a binary
in the **Contents/MacOS** directory, and modifying Patrick's current
script to launch the binary. This exploit works for versions of OSX
before the 11.3 "Big Sur" update.[@medium] He decides to use this as a
way to discretely deploy the Gopher ransomware.[@gopher-src] This will
encrypt only DOCX files that exist only in the
[\~/Documents](~/Documents) folder of the Alex's filesystem. It bypasses
Gatekeeper and other alarms, provided that the victim does not have an
app-level blocker. This seems ideal to Thom, as it will minimize any
chances of Alex discovering the attack.

# Stages of the Attack

## Reconnaissance

Thom knows that Alex will "show off" his Macbook to nearly anyone who
asks about it. Disguised as normal conversation, he asks leading
questions about the operating system and its security status.

Alex reveals that his Macbook is "out of date." He has not yet taken it
to the Apple store to get it checked out, because "everything else works
fine." Alex is of the mindset that "Macs don't get viruses." By this
mentality, he does not use any specialized firewall (like BlockBlock,
which would prevent unwanted applications from running, even if they
pass Gatekeeper checks). Alex uses his computer with a false sense of
security: that, without understanding why, the virtue of "being an Apple
product" will save him from any potential cyber attacks or malware
infections. However, Thom knows better.

Thom asks if he can "take a look at" the Macbook, because "maybe he can
help." There, Thom notes that Alex is running OSX version 11.2.3, and
has not updated to "Big Sur." When confronted, Alex once again replies
that "Macs don't get malware." He has no intention to update anytime
soon. With this information, Thom goes home, and researches available
vulnerabilities.

The most obvious choice seems to be the CVE-2021-30657. This would allow
Thom to install any number of applications, all of which bypass the
Gatekeeper checks.[@exploit-about] In addition, would provide not just a
one-time chance to exploit the system, but would allow a means to
continuously install more programs without Alex's knowledge.

## Weaponizing

Thom has a contact in the Cybersecurity industry, Patrick. Thom explains
Alex's current hardware specification, including the fact that it is
behind on security patches. He explains that this version is vulnerable
to Gatekeeper bypass, and asks if there are any solutions with which he
can perform such an exploit. Sure enough, Patrick sends him one, titled
**PoC.app**. Thom then realized that unpublished exploits for this exact
flaw already existed online.

From this, Thom notices that this bundle contains no **Info.plist**
file. Thom knows that **Info.plist** allows OSX to recognize a bundle
*as a bundle.* Without such a file, it will not be recognized as a
bundle. However, when he tries to execute it in his testing environment,
he learns that *it can still be executed*; and, in this case, it will
execute without triggering any alerts.

This sample inspires him to write his own exploit. The malicious script
specifically is located in **Contents/MacOS/Untitled-1**. This script
will serve as the launcher for the Gopher binary.

He clones a the Gopher source code from Github. Both Thom and Alex use a
Macbook that runs on 64-bit architecture, and thus does not use any
special compiler options to build this. He uses XCode to compile the
`gopher_encrypt` binary.Once the binary is created, he places it inside
the app bundle's **MacOS subdirectory**, the same directory as the
launcher script. The script's contents contain only the following[^1] :

[*\#!/bin/sh*]{style="color: 0.38,0.63,0.69"} ./gopher_encrypt

To make the bundle seem innocent, he then takes the following
precaution. He renames the bundle from **PoC.app** to
**Untitled-1.app**. Once he gains access to Alex's desktop, he will
adjust the icon to point to a PDF icon. This will ensure that the bundle
looks like a standard PDF file.[^2] Since most Macbooks hide file
extensions by default, Alex will be less likely to believe that this is
anything other than a harmless PDF file.

In order to get a Command and Control setup, he generates a set of
public/private SSH keys. This can be done with `ssh-keygen` in a user's
Terminal. He will copy the public key to Alex's computer. Once the
server is running, this key will give him direct access to Alex's
filesystem later on.

Thom formats a spare USB drive using the **FAT32** partition type. This
is a standard filesystem type that is supported by a large variety of
mainstream operating systems, including Macs. After formatting, Thom
copies the bundled app and public SSH key to the USB drive. He also
finds a copy of the OSX PDF icon, and saves it there as well.

Finally, he plans a time to hang out with Alex. He secures the flash
drive on his keychain, so as to prevent himself from losing it along the
way. He stops by the liquor store, then Alex's house. He pours drinks
with a heavy hand.

## Delivery

While at Alex's house, Thom waits for Alex to step away from his
computer. Through friendly bantering and inebriation, he knows that his
friend's guard is down. Alex steps to the restroom for a few minutes. He
left the computer unlocked. Thom begins the delivery. He inserts the USB
drive into Alex's Macbook, and opens the USB device in the file manager.
He copies all files to the correct location in Alex's filesystem. (This
is explained in greater detail in the [Install phase](#install).)

## Exploit

A machine running security patches prior to the **11.3** update are
vulnerable to Gatekeeper bypassing. This allows an app to run arbitrary
code without ever notifying the user. The **Untitled-1.app** script
contains the ransomware binary. Due to its lack of a .plist file, it
will run without notifying Alex.[^3] The nature of this CVE is explained
in greater detail in the [Technical Discussion of the Install
phase](#technical-discussion).

### STIX Viz Representations

#### Graph view

![image](C:/Users/Eric-PC/Documents/usf/spring2021/cis3213/final-project/stix-rep.PNG)

#### Tree view

![image](C:/Users/Eric-PC/Documents/usf/spring2021/cis3213/final-project/stix-tree.PNG)

### Soltra Edge Representation

![image](C:/Users/Eric-PC/Documents/usf/spring2021/cis3213/final-project/soltra-campaign.PNG)

## Install

First, Thom copes his own public SSH key to `~/authorized_keys`. Next,
he copies the **Untitled-1.app** bundle to Alex's Downloads directory.
He copies the PDF icon, right-clicks the app bundle, selects **Get
Info**, and pastes it into the **Icon** section. Finally, he uses the
**Sharing** window, and selects the **Remote Login** checkbox.[@ssh]
This gives Thom complete access to the system from anywhere he can get
internet access. This concludes the host configuration required to
manage the ransomware remotely.

At some point after he leaves Alex's house, he will then install the
actual ransomware through an SSH. From an SSH session, the bundle can be
executed in one line:

cd \~/Downloads [**&&**]{style="color: 0.00,0.44,0.13"}
./Untitled-1.apps

This will bypass any Gatekeeper or other alerts. To Alex, it will seem
like a random occurrence. Once it is successfully installed, all DOCX
files in Alex's `~/Documents` folder become encrypted. Finally, Thom
uses vi to write a text file on Alex's desktop, which explains the
attack and what to do about it. In particular, he demands that Alex send
a miniscule amount of money in order to get access to his files again.
He demands that this be paid in bitcoin, and provides a link where the
funds can be sent.

Technical details are discussed in the following subsection.

### Technical Discussion

This subsection will explain the lower-level details of the exploit. The
explanation and walkthrough was all taken from Patrick Wardle's post on
this CVE.[@exploit-about] The only significant changes were updates to
the wording for clarity, and to reference this report's contents.
Although Wardle wrote a script-based approach, a "script as a launcher
for a binary" can pull off the same results. In this case, the binary
will be the Gopher encryption and decryption programs.

This technical analysis will begin further down the subsection, "Root
Cause Analysis: To The Disassembler & Debugger!" The first portion of
this explains how to get logfiles which are used to infer what the
program is doing. In brief, the key takeaway is that the logger can be
configured to ascertain the following output from `syspolicyd` (sthe
component that determines whether or not an application is permitted to
execute):

[***GK evaluateScanResult:***]{style="color: 0.38,0.63,0.69"}[ *2, PST:
(path: /Users/Alex/Downloads/Untitled-1.app/Contents/MacOS/Untitled-1),
(team: (null)), (id: (null)), (bundle_id: NOT_A\_BUNDLE), 1, 0, 1, 0, 7,
0*]{style="color: 0.38,0.63,0.69"}

The `evaluateScanResult: 2` is unexpected behavior. For a script-based
.app file, it should yield a value of `0` instead. It is this very value
that makes the exploit possible. The following subsections audit
`syspolicyd` in order to understand the code and logic flaws that lead
to this result.

#### Exploiting the "script as a launcher"

Because the launcher is a script, `isScript` returns a non-zero value.
It calls `isBundled`, which returns zero. (This happens because
the`PolicyScanTarget`'s `bundled` instance variable is not set.)
Finally, this causes the method to return the problematic value, 0x2:

r15 = [0x2]{style="color: 0.25,0.63,0.44"};
[**if**]{style="color: 0.00,0.44,0.13"} (\[policyScanTarget isBundled\]
== [0x0]{style="color: 0.25,0.63,0.44"})
[**goto**]{style="color: 0.00,0.44,0.13"} leave;

leave: rax = r15; [**return**]{style="color: 0.00,0.44,0.13"} rax;

Thus, the evaluation logic is flawed. macOS determines that
`Untitled-1.app` is "not bundled," and returns **0x2** as the evaluation
type. (For expected behavior, it *should* return a value of 0x0
instead). This value of 0x2 will persist throughout the program's life
cycle. It will lead to conditions that introduce every problematic
behavior necessary to pull off the exploit.

#### Not evaluated as a bundle

The first problematic subroutine misclassifies the bundle (as "not a
bundle") because it lacks an `Info.plist` file. The following code
sample illustrates an important, flawed logic used to make this
judgement:

[**if**]{style="color: 0.00,0.44,0.13"} ( ((sub_100015829(rbx,
[@\"Contents/Info.plist\"]{style="color: 0.25,0.44,0.63"}) !=
[0x0]{style="color: 0.25,0.63,0.44"}) \|\| (sub_100015829(rbx,
[@\"Versions/Current/Resources/Info.plist\"]{style="color: 0.25,0.44,0.63"})
!= [0x0]{style="color: 0.25,0.63,0.44"})) \|\| (sub_100015829(rbx,
[@\"Info.plist\"]{style="color: 0.25,0.44,0.63"}) !=
[0x0]{style="color: 0.25,0.63,0.44"}))
[**goto**]{style="color: 0.00,0.44,0.13"} isBundle;

Wardle explains that this subroutine takes various measures to determine
if a `.plist` file is found within the bundle:

> This helper subroutine simply attempts to open such candidate files,
> and if found, checks for various keys (commonly found or required in
> an `Info.plist` file) such as `CFBundleIdentifier`, or
> `CFBundleExecutable`.

However, as noted, `Untitled-1.app` contains no such file. So, the code
proceeds without raising warnings.

Next, the `isAppWrapper` method attempts to determine if the item is an
"application wrapper." It tries to find `Untitled-1.app/Wrapper`
directory, which does not exist. Thus, the method returns a value of
zero (false).

As Wardle notes:

> As the `isAppWrapper:` method returns 0 (false), the code continues
> processing the remaining path components (`Contents`, `MacOS`, `PoC`),
> seeing if any have a path extension, and if so, have a candidate
> `Info.plist` file or is an "App Wrapper". As none do, the subroutine
> returns 0 (false), as according to it's logic, our `PoC.app` (which
> does not have an `Info.plist` file) is not a bundle.

To emphasize, "the subroutine returns 0 (false)" means that `isBundle`'
is also set to 0x0 (false). Thus,
`determineGatekeeperEvaluationTypeForTarget` method returns a value of
0x2. Of course, one would expect this to return a value of 0x0 instead.

#### Problematic evalType value: 0x2

One would expect the following code to execute, which would provide the
user with an alert (for example, a simple "Approve" or "Deny" button to
run the bundle or block it):

[**if**]{style="color: 0.00,0.44,0.13"} (\*(var_170 +
[0x18]{style="color: 0.25,0.63,0.44"}) !=
[0x2]{style="color: 0.25,0.63,0.44"})
[**goto**]{style="color: 0.00,0.44,0.13"} userBlocked;

userBlocked: [**if**]{style="color: 0.00,0.44,0.13"}
(os_log_type_enabled(rax, [0x0]{style="color: 0.25,0.63,0.44"}) !=
[0x0]{style="color: 0.25,0.63,0.44"}) { var_70 =
[0x0]{style="color: 0.25,0.63,0.44"}; rax =
\_os_log_impl(\_\_mh_execute_header, rbx,
[0x0]{style="color: 0.25,0.63,0.44"}, [\"Blocking executable due to user
not allowing\"]{style="color: 0.25,0.44,0.63"}, &var_70,
[0x2]{style="color: 0.25,0.63,0.44"}); }

However, it does not. The reason is because the evaluation type is set
to 0x2.

This value introduces the problematic behavior. (This is what generates
the `GK evaluateScanResult: 2` message noted earlier.) This fact alone
causes a myriad of issues to occur. In particular, it allows the
remainder of the method body not to raise alerts and skips logic checks
outright.

First, an `if` statement determines if the value is set to 0x2.

[**if**]{style="color: 0.00,0.44,0.13"} (evalType !=
[0x2]{style="color: 0.25,0.63,0.44"})
[**goto**]{style="color: 0.00,0.44,0.13"} notTwo;

This value matches the `evalType` in the exploit. Thus, the method
continues.

It then passes validation for all malware logic checks. In doing this,
it raises no alerts or prompts to the user. As Wardle notes:

> ...it checks if the evaluee matches known malware (via a call to a
> method named `xProtectResultIsBlocked`). Of course our PoC does not,
> so onwards we go. Though there are several other checks, they all
> appear spurious, but regardless all logic related to showing an alert
> or prompt to the user is skipped. This bears repeating! Normal
> `syspolicyd` will send an XPC message to the `CoreServicesUIAgent` in
> order to alert the user that the application is disallowed (for
> example if it s non-notarized), or even if signed and notarized a
> prompt requesting that the user explicitly approve the application.
> Here, all such logic is skipped, and no prompts or alerts are thus
> shown!

As noted, `syspolicyd` should interact with `CoreServicesUIAgent` to
prevent this validation from passing at all. However, it does not.

#### Problematic values in EvaluationResult

The program continues down the method body. The following behavior will
eventually set the `EvaluationResult` object to contain a problematic
value:

> Before the `evaluateScanResult:withEvaluationArguments:withPolicy:`
> methods returns, it executes some code that explicitly sets the `R12`
> register to `0x1` (true). This is relevant as later this value is
> passed into the `EvalutionResult` object's setAllowed'
> method...[@exploit-about]

The custom bundle will exploit the value set by this portion of the
code:

;true r12 = [0x1]{style="color: 0.25,0.63,0.44"}; \...

\[evalResult setAllowed:sign_extend_64(r12)\];

The `EvaluationResult` object contains the "system's policy evaluation
result" for the exploit bundle. Essentially, this determines how the
system will handle the contents of the bundle.

At this point, all numeric values in the `EvaluationResult` object are
set to zero (false):

After calling `setAllowed` (and to `setCacheResult`), the
`EvaluationResult` updates the object's values in the following way:

Note that the `allowed` instance variable is set to 1 (YES=true).
However, `wouldPrompt` and `didPrompt` are both set to 0 (NO=false).
This allows the system decides that a prompt is unnecessary. Thus, the
evaluation completes without displaying any prompt.

The completion block is invoked: that is, the initial pass to the
`evaluateCodeForUser:withPID:withProcessPath: ... withCompletionCallback:`
method. The completion callback block first invokes the
`EvaluationResult`'s `allowed` method to see if the the evaluation was
allowed.

[**if**]{style="color: 0.00,0.44,0.13"} (\[rax allowed\] !=
[0x0]{style="color: 0.25,0.63,0.44"})
[**goto**]{style="color: 0.00,0.44,0.13"} wasAllowed;

If it is allowed (which, as noted earlier, the exploit *is* allowed), it
invokes the `ExecManagerService`'s
`sendEvaluationResult:forEvaluationID:` passing in the
`EvaluationResult` object and an evaluation ID (in this instance the
value is 599).

#### Bypassing IOConnectCallMethod

The`sendEvaluationResult:forEvaluationID:` method calls into the kernel
via an `IOConnectCallMethod` call. Bypassing this allow the
`IOConnectCallMethod` calls to yield a few results:

1.  Resuming the suspended process (the exploit bundle)

2.  Logging the following messages:

        kernel: (AppleSystemPolicy) Waking up reference: 599
        kernel: (AppleSystemPolicy) Thread waiting on reference 599 woke up
        kernel: (AppleSystemPolicy) evaluation result: 599, allowed, cache, 1618125792

This illustrates the evaluation ID (599, in this example), and indicates
that the suspended evaluee process did, in fact, resume. Thus, the
exploit --- that is, the launcher for the ransomware binary --- runs as
normal.

## Command and Control

The SSH tunnel provides Thom with access to the system to exfiltrate
information, deliver new files, or modify unprivileged system settings
as needed. This will also serve as a means to decrypt the files once
Alex sends the requested bitcoin.

## Actions on Objectives

After Thom receives the bitcoin, he can generate the `gopher_decrypt`
binary, use the `scp` command to deploy it to Alex's system, and run it
to restore Alex's state to normal. He bundles it in the same way that he
did the `gopher_encrypt` binary during the [weaponizing
phase](#weaponizing), so it will also run quietly on Alex's system. He
uses the SSH session to remove his public key from
`~/.ssh/authorized_keys`, remove the **Untitled-1.app** file from the
desktop, and remove both the bundled encryption and decryption
applications.

Thom finds Alex in a vulnerable mindset. Now, his friend is more
amenable to taking upgrades seriously. Thom walks him throuh the process
to update his system to the 11.3 "Big Sur" update. He ridicules his
friend's once-relaxed position on computer security. This incident
finally proved to Alex that a user must take these updates seriously,
even when using a "secure laptop, like a Macbook." As a way to help, he
offers to take his friend out. He covers the tab with the bitcoin he
received from Alex.

# Incident-Handling Response

## Identification Phase

The most obvious indicator will be in the "most recent files," or the
"last accessed" metadata in some files. Since unwanted content can
sometimes be downloaded into a user's Downloads directory, one will find
that a file named "Untitled-1" stands out. One could further investigate
the timestamp to discover that this file was created the same day Thom
was over and on the computer. Finally, one could enable app extensions
and observe that this one ends with an .app suffix, even though it has a
PDF icon.

SSH opens up port 22 by default. The GUI provides no way to specify a
custom port for this. Running `netstat` with elevated user privileges
will reveal that this port is open. If this was not intended (which, in
Alex's case, it was not), then this will be a major red flag. One could
also check the `~/.ssh/authorized_keys` file to discover that a new key
(or, perhaps, *the only key*) has been added. A simple `netstat` command
(for example, `netstat -nt`) could reveal that the port is opened.
Wireshark could not sniff the contents of the packets, as the key-based
login encrypts the entire TCP stream. However, it could denote activity
and the source IP address, the endpoint from which the adversary is
performing their command-and-control actions.

## Eradication and Recovery Phase

-   Update to the 11.3 "Big Sur" patch. This will eliminate the problem
    at its root.

-   Install a stateful firewall in OSX. This firewall should prevent
    port and application access. For example, the BlockBlock application
    would have prevented the application from running without user
    intervention, even in the pre 11.3 versions of the operating system.

-   If Port 22 was *only* used for this assignment, block it at the
    router or firewall level.

-   Disable the SSH service if it is not currently in use. External
    access to the Macbook, through SSH, should be minimized if
    nonexistent. Since a Macbook is a portable computer, and is likely
    to be used outside of the local-area network, it is recommend not to
    use SSH at all on this system.

-   If it needs to be accessed remotely, use a VPN server (for example,
    using OpenVPN or Wireguard) to open an SSH tunnel to the Macbook.
    This provides a further level of security as a future attacker would
    need both SSH *and* VPN credentials to establish the connection.
    OpenVPN, for example, allows you to store the keys and certificate
    authorities in the root directory. This means that an attacker needs
    elevated privileges in order to exfiltrate or regenerate the VPN
    keys.

-   Regenerate all SSH keys. This is essential, especially if the
    Macbook remains in the LAN, but still needs to be accessed remotely.
    At the very least, this prevents unwanted access from any
    adversaries. If possible, buy a security key (like a Yubikey) and
    generate an SK keypair (for example, an `ed25519-sk` set). This
    requires a further authentication factor in order to establish a
    session.

## Lessons Learned Phase

Thom needs new friends: ones who share his position on computer
security. Alex exemplifies a far-too-common "false sense of security"
shared by many Apple users.

Thom was able to exploit this to make a simple point: that a computer is
only as secure as its user. He used a variety of techniques --- social
engineering, SSH tunneling, and arbitrary code execution --- to pull it
off. By the end of this, Alex is rethinking the limits of his Macbook's
security. He doesn't want to make the same mistake. Even though he
doesn't really understand how computers work, he now understands that
even his Macbook is vulnerable when it's under the wrong conditions.

Thus, Thom taught Alex another, more relevant point: updating your
system is important, if not essential. There's a reason why Apple has
such a great reputation for user security. However, a user's Macbook
realizes this only when the user follows the company's security posture
and practices.

# Exploit References

-   CVE-2021-30657
-   Gopher encrypt/decrypt

# References

\"About the security content of macOS Big Sur 11.3.\" *Apple*. 26 April
2021. <https://support.apple.com/en-us/HT212325>

\"Enable Remote Login to Start SSH Server in Mac OS X.\" *OSX Daily*. 30
September 2011.
<https://support.apple.com/guide/mac-help/allow-a-remote-computer-to-access-your-mac-mchlp1066/mac>

\"Gopher.\" *Github*. 04 September 2015.
<https://github.com/gdbinit/gopher>

Owens, Cedric. \"macOS Gatekeeper Bypass (2021 Edition).\" *Medium*. 26
April 2021.
<https://cedowens.medium.com/macos-gatekeeper-bypass-2021-edition-5256a2955508>

\"Safely open apps on your Mac.\" *Apple*.
<https://support.apple.com/en-us/HT202491>.

Wardle, Patrick. \"All Your Macs Are Belong To Us.\" *Objective-See*. 26
April 2021. <https://objective-see.com/blog/blog_0x64.html>

[^1]: In the \"Actions On Objectives\" section of this report, Thom will
    repeat the compiling and bundling process for the decryption binary.

[^2]: Icons are often denoted in the .plist file. However, this entire
    exploit works by omitting this file. This is the next-best solution,
    and was recommended in an email conversation with the article's
    author, Patrick Wardle himself.

[^3]: Recall that this setup does not use an app blocker, like
    BlockBlock. If the system had such a blocker, this exploit would not
    be possible.
